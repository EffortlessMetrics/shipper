# CircleCI configuration for Shipper
# Generated by `shipper ci circleci`
#
# This template provides a complete CI/CD pipeline for publishing Rust crates
# using Shipper. It includes caching, verification, and publishing jobs.

version: 2.1

orbs:
  rust: circleci/rust@1.6.0

jobs:
  check:
    executor:
      name: rust/default
      tag: 1.75.0
    resource_class: medium
    steps:
      - checkout

      - restore_cache:
          keys:
            - cargo-registry-{{ arch }}-{{ checksum "Cargo.lock" }}
            - cargo-registry-{{ arch }}

      - restore_cache:
          keys:
            - target-{{ arch }}-{{ checksum "Cargo.lock" }}
            - target-{{ arch }}

      - run:
          name: Format check
          command: cargo fmt --all -- --check

      - run:
          name: Clippy
          command: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - run:
          name: Run tests
          command: cargo test --workspace
          no_output_timeout: 30m

      - run:
          name: Run BDD compatibility matrix
          command: |
            for feature_set in "" "micro-auth" "micro-git" "micro-events" "micro-lock" "micro-encrypt" "micro-environment" "micro-storage" "micro-cargo" "micro-registry" "micro-process" "micro-webhook" "micro-types" "micro-config" "micro-state" "micro-store" "micro-all"; do
            if [ -z "$feature_set" ]; then
              cargo test -p shipper-cli --test bdd_publish -- --nocapture
            else
                cargo test -p shipper-cli --test bdd_publish --features "$feature_set" -- --nocapture
            fi
            done

      - save_cache:
          key: cargo-registry-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - ~/.cargo/registry
            - ~/.cargo/git

      - save_cache:
          key: target-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - target

  publish:
    executor:
      name: rust/default
      tag: 1.75.0
    resource_class: medium
    steps:
      - checkout

      - restore_cache:
          keys:
            - cargo-registry-{{ arch }}-{{ checksum "Cargo.lock" }}
            - cargo-registry-{{ arch }}

      - restore_cache:
          keys:
            - target-{{ arch }}-{{ checksum "Cargo.lock" }}
            - target-{{ arch }}

      - run:
          name: Install Shipper
          command: cargo install shipper-cli

      - run:
          name: Run shipper doctor
          command: shipper doctor
          environment:
            CARGO_REGISTRY_TOKEN: $CARGO_REGISTRY_TOKEN

      - run:
          name: Preflight verification
          command: shipper preflight
          environment:
            CARGO_REGISTRY_TOKEN: $CARGO_REGISTRY_TOKEN

      - run:
          name: Publish crates
          command: shipper publish
          environment:
            CARGO_REGISTRY_TOKEN: $CARGO_REGISTRY_TOKEN
          no_output_timeout: 60m

      - store_artifacts:
          path: .shipper
          destination: shipper-receipts

      - save_cache:
          key: cargo-registry-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - ~/.cargo/registry
            - ~/.cargo/git

      - save_cache:
          key: target-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - target

workflows:
  version: 2

  check-and-publish:
    jobs:
      - check:
          filters:
            branches:
              only: /.*/

      - publish:
          context: cargo-registry
          requires:
            - check
          filters:
            branches:
              only: main

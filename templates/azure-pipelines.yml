# Azure Pipelines template for Shipper
# Generated by `shipper ci azure`
#
# This template provides a complete CI/CD pipeline for publishing Rust crates
# using Shipper. It includes caching, verification, and publishing stages.

trigger:
  - main

pr:
  - main

variables:
  RUST_BACKTRACE: '1'
  CARGO_TERM_COLOR: 'always'

stages:
  - stage: Check
    displayName: 'Check & Test'
    jobs:
      - job: check
        displayName: 'Lint and Test'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseRustToolchain@0
            displayName: 'Install Rust'
            inputs:
              toolchain: 'stable'
              components: 'rustfmt,clippy'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache Cargo registry'
            inputs:
              key: 'cargo-registry | $(Agent.OS) | Cargo.lock'
              restoreKeys: |
                cargo-registry | $(Agent.OS)
              path: '$(HOME)/.cargo/registry'

          - task: Cache@2
            displayName: 'Cache Cargo git'
            inputs:
              key: 'cargo-git | $(Agent.OS) | Cargo.lock'
              restoreKeys: |
                cargo-git | $(Agent.OS)
              path: '$(HOME)/.cargo/git'

          - task: Cache@2
            displayName: 'Cache target directory'
            inputs:
              key: 'target | $(Agent.OS) | Cargo.lock'
              restoreKeys: |
                target | $(Agent.OS)
              path: 'target'

          - script: cargo fmt --all -- --check
            displayName: 'Format check'

          - script: cargo clippy --workspace --all-targets --all-features -- -D warnings
            displayName: 'Clippy'

          - script: cargo test --workspace
            displayName: 'Run tests'
            timeoutInMinutes: 30

  - stage: Publish
    displayName: 'Publish to crates.io'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    dependsOn: Check
    jobs:
      - job: publish
        displayName: 'Publish Crates'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseRustToolchain@0
            displayName: 'Install Rust'
            inputs:
              toolchain: 'stable'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache Cargo registry'
            inputs:
              key: 'cargo-registry | $(Agent.OS) | Cargo.lock'
              restoreKeys: |
                cargo-registry | $(Agent.OS)
              path: '$(HOME)/.cargo/registry'

          - task: Cache@2
            displayName: 'Cache target directory'
            inputs:
              key: 'target | $(Agent.OS) | Cargo.lock'
              restoreKeys: |
                target | $(Agent.OS)
              path: 'target'

          - script: |
              cargo install shipper-cli
            displayName: 'Install Shipper'

          - script: |
              shipper doctor
            displayName: 'Run shipper doctor'
            env:
              CARGO_REGISTRY_TOKEN: $(CARGO_REGISTRY_TOKEN)

          - script: |
              shipper preflight
            displayName: 'Preflight verification'
            env:
              CARGO_REGISTRY_TOKEN: $(CARGO_REGISTRY_TOKEN)

          - script: |
              shipper publish
            displayName: 'Publish crates'
            env:
              CARGO_REGISTRY_TOKEN: $(CARGO_REGISTRY_TOKEN)
            timeoutInMinutes: 60

          - task: PublishBuildArtifacts@1
            displayName: 'Publish receipts'
            inputs:
              PathtoPublish: '.shipper'
              ArtifactName: 'shipper-receipts'
              publishLocation: 'Container'
            condition: always()